FROM --platform=i386 i386/debian:bookworm
#FROM --platform=amd64 debian:bookworm

ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get clean && apt-get update && apt-get -y upgrade
RUN apt-get -y install curl build-essential gcc make && curl https://sh.rustup.rs -sSf | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Install essential packages
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    gcc-multilib \
    libc6-dev-i386 \
    && rm -rf /var/lib/apt/lists/*

# Install Rust using rustup
RUN curl https://sh.rustup.rs -sSf | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Add the i386 target
RUN rustup target add i686-unknown-linux-gnu

# Configure Cargo to use gcc for i386
RUN mkdir -p /root/.cargo
RUN echo '[target.i686-unknown-linux-gnu]\nlinker = "gcc -m32"' > /root/.cargo/config.toml

# Set environment variable for Cargo build target
ENV CARGO_BUILD_TARGET=i686-unknown-linux-gnu

# Upgrade pip, setuptools, and wheel
RUN pip3 install --upgrade pip setuptools wheel

# Install tiktoken
RUN pip3 install tiktoken==0.5.1 --break-system-packages

# Install runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    libssl1.1 \
    && rm -rf /var/lib/apt/lists/*

# Copy installed Python packages from builder
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /root/.cargo /root/.cargo

# Set PATH for Rust (if needed at runtime)
ENV PATH="/root/.cargo/bin:${PATH}"

# Update and upgrade the system, then install necessary packages including git
RUN apt-get -y install apt-utils gcc \
        python3.11 vim unzip ruby nodejs \
        fakeroot dbus base whiptail hexedit \
        patch wamerican ucf manpages \
        file luajit make dialog \
        less cowsay netcat-openbsd git python3-pip pipx git universal-ctags sudo \
        gfortran pkg-config libopenblas-dev liblapack-dev \
        libjpeg-dev libpng-dev zlib1g-dev libtiff-dev libfreetype6-dev universal-ctags \
        libportaudio2 pandoc cmake wget 

RUN apt-get clean && rm -rf /var/lib/apt/lists/*

RUN pip3 install --upgrade pip setuptools wheel tiktoken==0.5.1 --break-system-packages

# Create a non-root user
RUN useradd -m user && echo "user:password" | chpasswd

# Copy example files to the user's home directory
COPY --chown=user:user ./examples /home/user/examples

# Make all scripts in the lua directory executable
RUN chmod -R +x /home/user/examples/lua

# Set the working directory
WORKDIR /home/user/

# Set environment variables
ENV HOME="/home/user" \
    TERM="xterm" \
    USER="user" \
    SHELL="/bin/bash" \
    EDITOR="vim" \
    LANG="en_US.UTF-8" \
    LC_ALL="C"

# Set root password
RUN echo 'root:password' | chpasswd


RUN mkdir /app
RUN pip3 install aider-chat --break-system-packages

# Clone the GitHub repository into the 'template' directory
RUN git clone https://github.com/Nyttja-Labs/Template-server-experiment.git template

# Install Aider
#RUN wget -qO- https://aider.chat/install.sh | sh


# Switch to the non-root user for subsequent operations (optional)
USER user

# Default command
CMD [ "/bin/bash" ]
